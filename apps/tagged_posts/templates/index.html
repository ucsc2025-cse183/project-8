[[extend 'layout.html']]

<div id="app" class="p-4">
  <div style="display: flex; gap: 20px;">
    
    <!-- left column -->
    <div style="flex: 2;">
      <!-- Recipe Management Section -->
      <div class="recipe-section mb-4">
        <h2>My Recipes</h2>
        <button class="submit-content mb-3" @click="showNewRecipeForm = true" v-if="!showNewRecipeForm">Create New Recipe</button>
        
        <!-- New Recipe Form -->
        <div v-if="showNewRecipeForm" class="recipe-form border p-3 mb-3">
          <h3>{{ editingRecipe ? 'Edit Recipe' : 'New Recipe' }}</h3>
          <form @submit.prevent="submitRecipe">
            <div class="mb-2">
              <label for="recipe-name">Recipe Name:</label>
              <input id="recipe-name" v-model="new_recipe.name" type="text" required style="width: 100%;">
            </div>
            <div class="mb-2">
              <label for="recipe-type">Type:</label>
              <select id="recipe-type" v-model="new_recipe.type" required style="width: 100%;">
                <option value="breakfast">Breakfast</option>
                <option value="lunch">Lunch</option>
                <option value="dinner">Dinner</option>
                <option value="dessert">Dessert</option>
                <option value="snack">Snack</option>
              </select>
            </div>
            <div class="mb-2">
              <label for="recipe-description">Description:</label>
              <textarea id="recipe-description" v-model="new_recipe.description" rows="2" required style="width: 100%;"></textarea>
            </div>
            <div class="mb-2">
              <label for="recipe-servings">Servings:</label>
              <input id="recipe-servings" v-model.number="new_recipe.servings" type="number" required min="1" style="width: 100%;">
            </div>
            <div class="mb-2">
              <label for="recipe-instructions">Instructions:</label>
              <textarea id="recipe-instructions" v-model="new_recipe.instruction_steps" rows="4" required style="width: 100%;"></textarea>
            </div>
            
            <!-- Ingredients Section -->
            <div class="mb-2">
              <h4>Ingredients</h4>
              <div v-for="(ingredient, index) in new_recipe.ingredients" :key="index" class="ingredient-item mb-2">
                <select v-model="ingredient.id" required style="width: 60%;">
                  <option v-for="ing in availableIngredients" :key="ing.id" :value="ing.id">
                    {{ ing.name }}
                  </option>
                </select>
                <input v-model.number="ingredient.quantity_per_serving" type="number" min="0" step="0.1" required style="width: 20%;" placeholder="Qty">
                <button type="button" @click="removeIngredient(index)" class="ml-2">Remove</button>
              </div>
              <button type="button" @click="addIngredient" class="mt-2">Add Ingredient</button>
            </div>

            <div class="mt-3">
              <button type="submit" class="submit-content">Save Recipe</button>
              <button type="button" @click="cancelRecipe" class="ml-2">Cancel</button>
            </div>
          </form>
        </div>

        <!-- Recipe List -->
        <div class="recipe-list">
          <div v-for="recipe in myRecipes" :key="recipe.id" class="recipe-item border p-3 mb-3">
            <h3>{{ recipe.name }}</h3>
            <p><strong>Type:</strong> {{ recipe.type }}</p>
            <p><strong>Servings:</strong> {{ recipe.servings }}</p>
            <p>{{ recipe.description }}</p>
            <div class="mt-2">
              <button @click="editRecipe(recipe)" class="mr-2">Edit</button>
              <button @click="deleteRecipe(recipe.id)" class="mr-2">Delete</button>
              <button @click="viewRecipe(recipe)">View Details</button>
            </div>
          </div>
          <div v-if="myRecipes.length === 0" class="text-center p-3">
            No recipes yet. Create your first recipe!
          </div>
        </div>
      </div>

      <!-- Existing Post Section -->
      <textarea class="post-content" v-model="new_post" rows="4" style="width: 100%;"></textarea>
      <button class="submit-content" @click="submitPost">Post</button>

      <div class="feed mt-4">
        <div v-for="post in posts" :key="post.id" class="post_item border p-2 mt-2">
          <div>
            <strong>{{ post.created_by }}</strong> @ {{ formatDate(post.created_on) }}
          </div>
          <div>{{ post.content }}</div>
          <button v-if="post.can_delete" @click="deletePost(post.id)">Delete</button>
        </div>
      </div>
    </div>

    <!-- right column -->
    <div style="flex: 1;">
      <h3>Tags</h3>
      <div class="tags">
        <button 
          v-for="tag in tags" 
          :key="tag" 
          class="tag" 
          :class="{ selected: selected_tags.includes(tag) }"
          @click="toggleTag(tag)">
          {{ tag }}
        </button>
      </div>

      <h3 class="mt-4">Add New Ingredient</h3>
      <form @submit.prevent="submitIngredient">
        <div>
          <label for="ingredient-name">Name:</label>
          <input id="ingredient-name" v-model="new_ingredient.name" type="text" required style="width: 100%;">
        </div>
        <div class="mt-2">
          <label for="ingredient-unit">Unit:</label>
          <input id="ingredient-unit" v-model="new_ingredient.unit" type="text" style="width: 100%;">
        </div>
        <div class="mt-2">
          <label for="ingredient-calories">Calories per Unit:</label>
          <input id="ingredient-calories" v-model.number="new_ingredient.calories_per_unit" type="number" style="width: 100%;">
        </div>
        <div class="mt-2">
          <label for="ingredient-description">Description:</label>
          <textarea id="ingredient-description" v-model="new_ingredient.description" rows="2" style="width: 100%;"></textarea>
        </div>
        <button type="submit" class="submit-content mt-2">Add Ingredient</button>
      </form>

      <h3 class="mt-4">All Ingredients</h3>
      <div class="search-ingredients mt-2">
        <input v-model="search_ingredient_name" placeholder="Search ingredients by name..." style="width: 70%;">
        <button @click="loadIngredients(search_ingredient_name)" class="submit-content ml-2">Search</button>
        <button v-if="search_ingredient_name" @click="clearSearch" class="submit-content ml-2">Clear</button>
      </div>
      <ul class="ingredient-list">
        <li v-for="ingredient in ingredients" :key="ingredient.id" class="border p-2 mt-2">
          <strong>{{ ingredient.name }}</strong> ({{ ingredient.unit || 'N/A' }})<br>
          Calories/Unit: {{ ingredient.calories_per_unit || 'N/A' }}<br>
          <span v-if="ingredient.description">{{ ingredient.description }}</span>
        </li>
        <li v-if="ingredients.length === 0">No ingredients found. Add some above!</li>
      </ul>
    </div>
  </div>
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      new_post: "",
      posts: [],
      tags: [],
      selected_tags: [],
      new_ingredient: {
        name: "",
        unit: "",
        calories_per_unit: null,
        description: ""
      },
      ingredients: [],
      search_ingredient_name: "",
      // New recipe-related data
      showNewRecipeForm: false,
      editingRecipe: null,
      myRecipes: [],
      new_recipe: {
        name: "",
        type: "",
        description: "",
        servings: 1,
        instruction_steps: "",
        ingredients: []
      }
    };
  },
  computed: {
    availableIngredients() {
      return this.ingredients;
    }
  },
  methods: {
    formatDate(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleString();
    },
    async loadPosts() {
      let tagParams = this.selected_tags.join(",");
      let url = `/tagged_posts/api/posts` + (tagParams ? `?tags=${tagParams}` : "");
      const r = await fetch(url);
      const data = await r.json();
      this.posts = data.posts;
    },
    async loadTags() {
      const r = await fetch(`/tagged_posts/api/tags`);
      const data = await r.json();
      this.tags = data.tags;
    },
    async loadIngredients(search_term = '') {
      let url = `/tagged_posts/api/ingredients`;
      if (search_term) {
        url += `?name=${encodeURIComponent(search_term)}`;
      }
      const r = await fetch(url);
      const data = await r.json();
      this.ingredients = data.ingredients;
    },
    async submitPost() {
      if (!this.new_post.trim()) return;
      await fetch(`/tagged_posts/api/posts`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ content: this.new_post })
      });
      this.new_post = "";
      await this.refresh();
    },
    async deletePost(id) {
      await fetch(`/tagged_posts/api/posts/${id}`, { method: "DELETE" });
      await this.refresh();
    },
    async toggleTag(tag) {
      if (this.selected_tags.includes(tag)) {
        this.selected_tags = this.selected_tags.filter(t => t !== tag);
      } else {
        this.selected_tags.push(tag);
      }
      await this.loadPosts();
    },
    async submitIngredient() {
      if (!this.new_ingredient.name.trim()) {
        alert("Ingredient name is required!");
        return;
      }
      try {
        const r = await fetch(`/tagged_posts/api/ingredients`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(this.new_ingredient)
        });
        if (r.ok) {
          const data = await r.json();
          alert(data.message || "Ingredient added successfully!");
          this.new_ingredient = {
            name: "",
            unit: "",
            calories_per_unit: null,
            description: ""
          };
          await this.loadIngredients();
        } else {
          const errorData = await r.json();
          alert(`Error adding ingredient: ${errorData.message || r.statusText}`);
        }
      } catch (e) {
        console.error("Network or parsing error:", e);
        alert("An unexpected error occurred while adding the ingredient.");
      }
    },
    // New recipe-related methods
    async loadMyRecipes() {
      try {
        const r = await fetch('/tagged_posts/api/recipes/my');
        const data = await r.json();
        this.myRecipes = data.recipes;
      } catch (e) {
        console.error("Error loading recipes:", e);
      }
    },
    addIngredient() {
      this.new_recipe.ingredients.push({
        id: null,
        quantity_per_serving: 1
      });
    },
    removeIngredient(index) {
      this.new_recipe.ingredients.splice(index, 1);
    },
    async submitRecipe() {
      try {
        const url = this.editingRecipe 
          ? `/tagged_posts/api/recipes/${this.editingRecipe.id}`
          : '/tagged_posts/api/recipes';
        
        const method = this.editingRecipe ? 'PUT' : 'POST';
        
        const r = await fetch(url, {
          method: method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(this.new_recipe)
        });
        
        if (r.ok) {
          const data = await r.json();
          alert(data.message || "Recipe saved successfully!");
          this.cancelRecipe();
          await this.loadMyRecipes();
        } else {
          const errorData = await r.json();
          alert(`Error saving recipe: ${errorData.message || r.statusText}`);
        }
      } catch (e) {
        console.error("Error saving recipe:", e);
        alert("An unexpected error occurred while saving the recipe.");
      }
    },
    editRecipe(recipe) {
      this.editingRecipe = recipe;
      this.new_recipe = {
        name: recipe.name,
        type: recipe.type,
        description: recipe.description,
        servings: recipe.servings,
        instruction_steps: recipe.instruction_steps,
        ingredients: recipe.ingredients.map(ing => ({
          id: ing.ingredient_id,
          quantity_per_serving: ing.quantity_per_serving
        }))
      };
      this.showNewRecipeForm = true;
    },
    async deleteRecipe(recipeId) {
      if (!confirm("Are you sure you want to delete this recipe?")) return;
      
      try {
        const r = await fetch(`/tagged_posts/api/recipes/${recipeId}`, {
          method: 'DELETE'
        });
        
        if (r.ok) {
          await this.loadMyRecipes();
        } else {
          const errorData = await r.json();
          alert(`Error deleting recipe: ${errorData.message || r.statusText}`);
        }
      } catch (e) {
        console.error("Error deleting recipe:", e);
        alert("An unexpected error occurred while deleting the recipe.");
      }
    },
    viewRecipe(recipe) {
      // TODO: Implement recipe detail view
      alert("Recipe detail view coming soon!");
    },
    cancelRecipe() {
      this.showNewRecipeForm = false;
      this.editingRecipe = null;
      this.new_recipe = {
        name: "",
        type: "",
        description: "",
        servings: 1,
        instruction_steps: "",
        ingredients: []
      };
    },
    async refresh() {
      await this.loadPosts();
      await this.loadTags();
      await this.loadIngredients();
      await this.loadMyRecipes();
    },
    async clearSearch() {
      this.search_ingredient_name = '';
      await this.loadIngredients();
    }
  },
  mounted() {
    this.refresh();
  }
}).mount("#app");
</script>

<style>
.selected {
  background-color: #00aaff;
  color: white;
}
.tag {
  margin: 4px;
  padding: 6px;
  border: 1px solid #ccc;
  background: #f0f0f0;
  cursor: pointer;
}
.recipe-form {
  background-color: #f8f9fa;
  border-radius: 4px;
}
.ingredient-item {
  display: flex;
  align-items: center;
  gap: 8px;
}
.ml-2 {
  margin-left: 8px;
}
.mr-2 {
  margin-right: 8px;
}
.mb-2 {
  margin-bottom: 8px;
}
.mb-3 {
  margin-bottom: 12px;
}
.mb-4 {
  margin-bottom: 16px;
}
.mt-2 {
  margin-top: 8px;
}
.mt-3 {
  margin-top: 12px;
}
.mt-4 {
  margin-top: 16px;
}
.text-center {
  text-align: center;
}
</style>

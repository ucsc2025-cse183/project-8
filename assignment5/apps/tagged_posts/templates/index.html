[[extend 'layout.html']]

<div id="app" class="p-4">
  <div style="display: flex; gap: 20px;">
    
    <!-- left column -->
    <div style="flex: 2;">
      <textarea class="post-content" v-model="new_post" rows="4" style="width: 100%;"></textarea>
      <button class="submit-content" @click="submitPost">Post</button>

      <div class="feed mt-4">
        <div v-for="post in posts" :key="post.id" class="post_item border p-2 mt-2">
          <div>
            <strong>{{ post.created_by }}</strong> @ {{ formatDate(post.created_on) }}
          </div>
          <div>{{ post.content }}</div>
          <button v-if="post.can_delete" @click="deletePost(post.id)">Delete</button>
        </div>
      </div>
    </div>

    <!-- right column -->
    <div style="flex: 1;">
      <h3>Tags</h3>
      <div class="tags">
        <button 
          v-for="tag in tags" 
          :key="tag" 
          class="tag" 
          :class="{ selected: selected_tags.includes(tag) }"
          @click="toggleTag(tag)">
          {{ tag }}
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      new_post: "",
      posts: [],
      tags: [],
      selected_tags: []
    };
  },
  methods: {
    formatDate(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleString();
    },
    async loadPosts() {
      let tagParams = this.selected_tags.join(",");
      let url = `/tagged_posts/api/posts` + (tagParams ? `?tags=${tagParams}` : "");
      const r = await fetch(url);
      const data = await r.json();
      this.posts = data.posts;
    },
    async loadTags() {
      const r = await fetch(`/tagged_posts/api/tags`);
      const data = await r.json();
      this.tags = data.tags;
    },
    async submitPost() {
      if (!this.new_post.trim()) return;
      await fetch(`/tagged_posts/api/posts`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ content: this.new_post })
      });
      this.new_post = "";
      await this.refresh();
    },
    async deletePost(id) {
      await fetch(`/tagged_posts/api/posts/${id}`, { method: "DELETE" });
      await this.refresh();
    },
    async toggleTag(tag) {
      if (this.selected_tags.includes(tag)) {
        this.selected_tags = this.selected_tags.filter(t => t !== tag);
      } else {
        this.selected_tags.push(tag);
      }
      await this.loadPosts();
    },
    async refresh() {
      await this.loadPosts();
      await this.loadTags();
    }
  },
  mounted() {
    this.refresh();
  }
}).mount("#app");
</script>

<style>
.selected {
  background-color: #00aaff;
  color: white;
}
.tag {
  margin: 4px;
  padding: 6px;
  border: 1px solid #ccc;
  background: #f0f0f0;
  cursor: pointer;
}
</style>
